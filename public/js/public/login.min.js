const auth_hash=document.getElementById("auth_hash").value,decoder=new TextDecoder,enc=new TextEncoder,chooseMfa=async event=>{if("choose-mfa"!=event.currentTarget.id)return;const mfaTypeArr=Array.from(document.getElementsByName("mfaType")).filter((e=>e.checked)),mfaType=1==mfaTypeArr.length?mfaTypeArr.pop().value:null;if("webauthn"==mfaType)return document.querySelector(".LoginCard__card.choose-mfa").classList.add("hide"),document.querySelector(".LoginCard__card.confirm-webauthn").classList.remove("hide"),verifyWebauthn();"totp"==mfaType&&(document.querySelectorAll(".totp__fieldset input")[0].focus(),document.querySelector(".LoginCard__card.choose-mfa").classList.add("hide"),document.querySelector(".LoginCard__card.verify-totp").classList.remove("hide"))},verifyTotp=async event=>{const totp_code=Array.from(document.querySelectorAll(".totp__fieldset input")).map((n=>n.value)).join(""),json=await Fetch.post({target:"/verify/totp",body:{recaptcha_token:recaptcha_token,auth_hash:auth_hash,totp_code:totp_code}});if(json.status&&"success"==json.status){const successEl=document.querySelector(".verify-totp .success-checkmark_off");successEl.classList.remove("success-checkmark_off"),successEl.classList.remove("hide"),successEl.classList.add("success-checkmark"),document.querySelector(".totp__fieldset").classList.add("invisible"),document.getElementById("totp-message").textContent=json.message,localStorage.setItem("_apiKeySecret",json.api_key_secret),setTimeout((()=>{document.getElementById("app-link").click()}),3e3)}},verifyWebauthn=async()=>{if(0===app.keys.length)return void alert("No device registered");const allowCredentials=[];for await(const key of app.keys)allowCredentials.push({id:base64ToArrayBuffer(key.webauthn_id),type:"public-key",transports:["usb","ble","nfc","internal"]});const assertion=await navigator.credentials.get({publicKey:{challenge:enc.encode(app.apiKeyId),rpId:app.domainName,userVerification:"discouraged",allowCredentials:allowCredentials,timeout:9e4}}).catch(console.error);if(assertion){const response=assertion.response,authData=new Uint8Array(response.authenticatorData),clientDataJSON=new Uint8Array(response.clientDataJSON),rawId=new Uint8Array(assertion.rawId),sig=new Uint8Array(response.signature),assertionClientExtensions=assertion.getClientExtensionResults(),assertion_response={id:assertion.id,rawId:arrayBufferToBase64(rawId),type:assertion.type,authData:arrayBufferToBase64(authData),clientData:arrayBufferToBase64(clientDataJSON),signature:hexEncode(sig),assertionClientExtensions:JSON.stringify(assertionClientExtensions)},json=await Fetch.post({target:"/verify/webauthn",body:{recaptcha_token:recaptcha_token,auth_hash:auth_hash,assertion_response:assertion_response}});if(json.status&&"success"==json.status){const successEl=document.querySelector(".confirm-webauthn .success-checkmark_off");successEl.classList.remove("success-checkmark_off"),successEl.classList.remove("hide"),successEl.classList.add("success-checkmark"),document.querySelector(".confirm-webauthn .ChooseMfa__subheader").textContent=json.message,document.querySelector(".confirm-webauthn img").remove(),document.querySelector(".confirm-webauthn .ChooseMfa__parra").classList.add("invisible"),localStorage.setItem("_apiKeySecret",json.api_key_secret),setTimeout((()=>{document.getElementById("app-link").click()}),3e3)}}};grecaptcha.ready((()=>{init_recaptcha("login_action")}));const check_totp_fieldset=async event=>{event.preventDefault();const input=event.currentTarget.value;if(!input)return;const number=parseInt(input,10);if(!number.between(0,9,!0))return void(event.currentTarget.value=Array.from(input).shift());event.currentTarget.value=number;if(6===Array.from(document.querySelectorAll(".totp__fieldset input")).map((n=>n.value)).join("").length){return document.getElementById("verify-totp").setAttribute("disabled",!0),verifyTotp()}event.target.nextElementSibling.focus()},handle_totp_paste=async event=>{event.stopPropagation(),event.preventDefault();const totp_code=(event.clipboardData||window.clipboardData).getData("Text");if(!totp_code)return;const firstEl=document.querySelectorAll(".totp__fieldset input")[0];if(6===totp_code.length){let thisEl=firstEl;for(const num of Array.from(totp_code)){if(thisEl.value=num,!thisEl.nextElementSibling)break;thisEl=thisEl.nextElementSibling}return document.getElementById("verify-totp").setAttribute("disabled",!0),verifyTotp()}firstEl.focus()};document.addEventListener("DOMContentLoaded",(async()=>{"/login"!=location.pathname&&history.pushState({},document.title,"/login"),"credentials"in navigator||(document.querySelector(".ChooseMfa__label.webauthn").title="Hardware Security Keys are not supported on this browser",document.querySelector(".ChooseMfa__label.webauthn").classList.add("disabled"),document.querySelector(".ChooseMfa__label.webauthn input").disabled=!0);const chooseMfaEl=document.getElementById("choose-mfa");chooseMfaEl.addEventListener("click",chooseMfa,!1),chooseMfaEl.addEventListener("touchstart",chooseMfa,!!supportsPassive&&{passive:!0});const retryWebauthnEl=document.getElementById("retry-webauthn");retryWebauthnEl.addEventListener("click",verifyWebauthn,!1),retryWebauthnEl.addEventListener("touchstart",verifyWebauthn,!!supportsPassive&&{passive:!0});const verifyTotpEl=document.getElementById("verify-totp");verifyTotpEl.addEventListener("click",verifyTotp,!1),verifyTotpEl.addEventListener("touchstart",verifyTotp,!!supportsPassive&&{passive:!0});for(const el of document.querySelectorAll(".totp__fieldset input"))el.addEventListener("input",check_totp_fieldset,!1),el.addEventListener("paste",handle_totp_paste,!1)}),!1);